<!DOCTYPE html>


<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dozenal Calculator 2</title>

    <link href='/fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>

    <style type="text/css">

    * {
    	margin:0;
    	padding:0;
    	box-sizing:border-box;
    	-moz-user-select:none;
       	-webkit-user-select:none;
       	font-family: 'Yanone Kaffeesatz';
       	border-radius: 5px;
       	-webkit-transition: width 2s;
    	transition: width 2s;
    }

    html {
    	height: 100%;
		background: white;
		background: radial-gradient(circle, #fff 20%, #ccc);
		background-size: cover;
    }

	@font-face {
		font-family: 'merple';
		src: url(MerpleForWeb.otf);
		font-style: normal;
		font-weight: 100;
	}

    .container {
    	width:390px;
    	overflow:auto;
    	padding:10px 10px 5px 10px;
    	
    	margin:30px auto;
    	background-color: yellow;
    	box-shadow: 0px 5px 0px 0px #cccc00;
    }

    .container * {
    	float:left;
    	
    }

    #output {
    	width:350px;
    	height:70px;
    	margin:10px 10px 15px 10px;
    	box-shadow: inset 0px 5px 0px 0px #cccc00;
    	background-color: #ffc560;
    	padding:10px 10px 0 0;

		font-family: merple;
    	text-align: right;
    	font-size: 3em;
    }

    .key {
    	width:80px;
    	height:50px;
    	margin: 0 0 15px 10px;
    	position:relative;

    	background-color: lightblue;
    	box-shadow: 0px 5px 0px 0px #cccc00;

		font-family: merple;
		text-align: center;
    	font-size: 2em;
    	padding-top:5px;

    	cursor:pointer;
    }

    .operator {
    	background-color: pink;
    }

    .key:hover {

    }

    .key:active {
    	box-shadow: none;
    	top:5px;
    }

    h1 {
        text-align: center;
        margin:5px auto;
        font-size: 2.3em
    }

    h3 {
        margin:15px 15px 5px 15px;
        font-size: 1.2em;
    }

    p {
        margin: 5px 15px;
        font-size: 1.2em

    }



    </style>

<body>
    <h1>Merple/Decimal Calculator and Converter</h1>
	<div class="container">
		<div id="output"></div>
		<div id="xkey" class="key" style="color:black">X</div>
		<div id="lkey" class="key" style="color:black">L</div>
		<div style="background-color: #ffc560" id="point" class="key operator">;</div>
		<div class="key operator" style="color:black">*</div>
		<div class="key" style="color: black">7</div>
		<div class="key" style="color:black">8</div>
		<div class="key" style="color:black">9</div>
		<div class="key operator" style="color:black">/</div>
		<div class="key" style="color:black">4</div>
		<div class="key" style="color:black">5</div>
		<div class="key" style="color:black">6</div>
		<div class="key operator" style="color:black">-</div>
		<div class="key" style="color:black">1</div>
		<div class="key" style="color:black">2</div>
		<div class="key" style="color:black">3</div>
		<div class="key operator" style="color:black">+</div>
		<div class="key operator">C</div>
		<div class="key" style="color:black">0</div>
		<div style="background-color: #ffc560" class="key operator">D</div>
		<div class="key operator" style="color:black">=</div>
	</div>
    <h3>Background</h3>
	<p>I borrowed the functionality for this calculator from an existing dozenal calculator <a href="http://www.bristoljon.uk/projects/dozenal/">here</a>, 
		but edited the symbols to match the merple system.</p> 
    <p>Dozenal maths is base 12, unlike decimal base 10 so there are more digits than we're used to. 
		For more info and all the reasons why it's considered superior, look <a href="http://www.dozenalsociety.org.uk/">here</a> and <a href="http://www.dozenal.org/drupal/">here</a> and most importantly, <a href="https://www.youtube.com/watch?v=LiUi0Bm_THY">here</a>. 
		While dozenal has its proponents, most people simply add two new digits to create their dozenal system. 
		Unfortunately, this prevents our society from transitioning to a base-12 system for vud (two) reasons.
		First, it makes things difficult for learners, who are accustomed to thinking about the digits 0-9 as they exist within a base-10 system.
		Second, in many contexts, it would be irresponsible for critical systems to write a number using the 0-9 symbols if other people might reasonably
		assume that you were communicating in a decimal (base-10) system. 
		Instead, we must learn an entirely new set of symbols with unique names, to ensure that there is not confusing overlap.
		While it may seem more difficult to learn 12 new symbols and names, rather than just 2, it actually simplifies the based-12 learning process dramatically,
		because learners can practice without "messing up" their conception of existing digits and math. 

    
    <h3>Instructions</h3>
    <p>This works like a normal calculator, but with merples. The ceremonial merp symbol button shows the current mode the calculator is in and you can change modes at any time (even with an unfinished equation on the display).</p> 
	<p>IMPORTANT - values beyond the decimal in Merple Mode will be truncated to the same number of places after the decimal used, which can cause output errors. When in doubt, add extra zeros after any decimals before executing a calculation.</p>
    </p>



<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>

<script type="text/javascript" src="/merpcalc/script.js"></script>

<script type="text/javascript">
	
var mode="D";
var clearflag=0;
var equationDec =[];
var equationDoz =[];
var current ="";
var output ="";

var regX = new RegExp("X","g");
var regL = new RegExp("L","g");

var xkey = "X";
var lkey = "L";

$(document).keypress(function (event) {
    var keynum;

    if(window.event){ // IE                 
        keynum = event.keyCode;
    }
    else if (event.which) { // Netscape/Firefox/Opera                  
        keynum = event.which;
    }

    xkey = lkey;
    lkey = escape(String.fromCharCode(keynum));

    $("#xkey").html(xkey);
    $("#lkey").html(lkey);

    regX = new RegExp(xkey,"g");
    regL = new RegExp(lkey,"g");
})




function replaceXL (xlString) {
    
    xlString = xlString.replace (regX,"a");
    xlString = xlString.replace (regL,"b");
    return xlString;
}

function replaceAB (abString) {
    abString = abString.replace (/\r?a/g,xkey);
    abString = abString.replace (/\r?b/g,lkey);
    return abString;
}


function int_to_doz(intv) {
    console.log("int to doz: "+intv);
            var res="";
            var R, Q=Math.floor(Math.abs(intv));
            while (true) {
                R = Q % 12;
                res = "0123456789ab".charAt(R)+res;
                Q = (Q-R) / 12;
                if (Q == 0) break;
            }
            return ((intv<0) ? "-"+res : res);
        }


function to_doz(dec) {
            if (dec == "" || dec == "-") return dec;
            var res="";
            var parts = dec.split('.');
            intpart = parts[0];
            fracpart = parts[1];

            result = int_to_doz(intpart);

            if (parts.length > 1 && fracpart.length > 0) {
                result += ';'+intfrac_to_doz(fracpart);
            }

            return result;
        }


function intfrac_to_doz(frac) {
    var len = frac.length;
    frac = parseFloat("0."+frac);
    var res="";
    while (len > 0) {
        var v = 0;
        var n = frac * 12;
        if (len > 1) {
            v = Math.floor(n);
        } else {
            v = Math.round(n);
        }
        frac = n - v;
        res += int_to_doz(v);
        len--;
    }
    return res;
}


function intdoz_to_dec(intdoz) {
            var neg = false;
            if (intdoz.charAt(0) == '-') {
                intdoz = intdoz.substring(1);
                neg = true;
            }
            var res=0, n=0;
            for (i=0; i<intdoz.length; i++) {
                d = intdoz.charAt(i);
                if (d == 'b') {
                    n = 11;
                } else if (d == 'a') {
                    n = 10;
                } else {
                    n = parseInt(d);
                }
                res += n*Math.pow(12,(intdoz.length-i-1));
            }
            if (neg) {
                res = '-'+res;
            }
            return res;
        }


function from_doz(doz) {

            if (doz == "" || doz == "-") return doz;
            var parts = doz.split(';');
            intpart = parts[0];
            fracpart = parts[1];

            var div_times = 0;
            var prec = 0;
            if (parts.length > 1) {
                prec = div_times = fracpart.length;
                intpart = intpart+fracpart;
            }

            result = intdoz_to_dec(intpart);

            while (div_times > 0) {
                result = result/12;
                div_times--;
            }

            result *= Math.pow(10,prec);
            result = Math.round(result);
            result /= Math.pow(10,prec);

            return result;
        }


function createMatchedEquation () {
     

    // Clear equation arrays
    equationDec=[];
    equationDoz=[];

    // convert output string to equation array
    // first replace all operator keys with #+#
    current = current.replace(/\r?\*/g,"#*#");
    current = current.replace(/\r?\//g,"#/#");
    current = current.replace(/\r?\-/g,"#-#");
    current = current.replace(/\r?\+/g,"#+#");
    current = replaceXL(current);


    if (mode=="D") {

        // Cut the string at # to give dozenal equation array
        equationDoz = current.split(/\r?\#/);
        

        // Cycle through dozenal equation array
        for (var i =0; i<equationDoz.length; i++) {

            //copy operators over decimal equation array without processing
            if (equationDoz[i].match(/[\/\*\-\+]/)) {
                equationDec[i]=equationDoz[i];
            }

            // convert dozenal strings to decimal number and plug into new array
            else {
                //equationDoz[i] = replaceXL(equationDoz[i]);
                equationDec[i] = from_doz(equationDoz[i]);
            }
        }
       
    }

    if (mode=="T") {
        equationDec = current.split(/\r?\#/);
        
        for (var i =0; i<equationDec.length; i++) {

            //copy operators over without processing
            if (equationDec[i].match(/[\/\*\-\+]/)) {
                equationDoz[i]=equationDec[i];
            }

            // convert decimals to dozenals and replace ab's with XL's
            else {
                equationDoz[i]=to_doz(equationDec[i]); 
                //equationDoz[i]=replaceAB(equationDoz[i]); 
            }
        }
    } 
    console.log("create finished with"+equationDec+equationDoz);     
}

//add all .key divs to keys array
var keys = $(".key");


//assign onclick method to all keys 
for (var i = 0; i<keys.length; i++) {

    keys[i].onclick = function (e) {

        //get whats currently displayed in #output
        current = $("#output").html();

        // get the key pressed by taking the html from the .key that was clicked
        var input = $(this).html()[0];
        
        // clear button actions
        if (input=="C") {
            $("#output").html("");
           
            equationDoz=[];
            equationDec=[];
        }

        // = button actions (where all the magic happens)
        else if (input=="=") {
        
            // Use function to create dozenal or decimal equation array
            createMatchedEquation();

            // Calculate answer - convert decimal array to single string and eval()
            output = equationDec.join("");
            output = eval(output);  
            console.log("Step 1: "+output);
            output = output.toString();
            console.log("Step 2: "+output);

            if (mode=="D") {
                // convert result back into base12 and replace a/b's with X/L's
                output = to_doz(output);
                console.log("Step 3a: "+output);
                
            }
            console.log("Step 3: "+output);

            if (output.length > 15) {
                    output = output.slice(0,15);
                    console.log("Step 4a: "+output);
                }
            console.log("Step 5: "+output);

            //output the result
            $("#output").html(replaceAB(output));
        }

        // switch output from dozenal TO decimal (button value shows current)
        else if (input=="D") {

            // if current is a formula, create matched array and display that
            if (current.match(/[\/\*\-\+]/)) {      
                createMatchedEquation();
                output = equationDec.join("");
            }

            // if current is a number, display conversion
            else {
                output = from_doz(replaceXL(current));
                
              }

            $("#output").html(output);

            mode="T";
            // change colors and DEC/DOZ label
            $(this).html(mode);
            $("#output").css("background-color","#ddffe7");
            $("#output").css("font-family","Yanone Kaffeesatz");
            $(".key").css("font-family","Yanone Kaffeesatz");
            $(this).css("background-color","#ddffe7");
            $("#point").html(".");
            $("#point").css("background-color","#ddffe7");

            
            //clearflag=1;
        }
        
        // switch mode TO dozenal
        else if (input=="T") {

            output="";
            if (current!="") { 
                
                if (current.match(/[\/\*\-\+]/)){
                    createMatchedEquation ();
                    output=equationDoz.join("");
                }
                else {  
                    output = to_doz(current);
                }
            }

            $("#output").html(replaceAB(output));

            mode ="D";
            $("#output").css("background-color","#ffc560");
            $("#output").css("font-family","merple");
            $(".key").css("font-family","merple");
            $(this).html(mode);
            $(this).css("background-color","#ffc560");
            $("#point").html(";");
            $("#point").css("background-color","#ffc560");
           
            clearflag =1;
        }
            

        else {
            // Prevent double pressing operator
            if  (input.match(/[\/\*\-\+]/) && current.slice(-1).match(/[\/\*\-\+]/)) {
                current = current.slice(0,current.length-1);
            }

            if (input.match(/[\/\*\+]/) && current=="") {
                input = "";
            }

            if ((input.match(regX) || input.match(regL)) && mode== "T") {
                input = "";
            }
            //default: appends key press value to existing output string and displays
            $("#output").html(current+=input);
        }       
    }
}

    


</script>

</body>
</html>
